name: Release (manual)

on:
  workflow_dispatch:
    inputs:
      extension-version:
        description: "Extension version to be released"
        required: true
      release-notes:
        description: "Release notes of the extension"
        required: true
      background-version:
        description: "Background version to be used"
        required: true
      ui-version:
        description: "UI version to be used"
        required: true
      provider-version:
        description: "Provider version to be used"
        required: true
      pre-release:
        type: boolean
        required: false
        default: false
        description: Is a pre-release?

env:
  RELEASE_BRANCH: release/${{ github.event.inputs.extension-version }}
  GH_ACCESS_TOKEN: ${{ secrets.USER_PAT }}:${{ secrets.PAT }}
  EXTENSION_NAME: block-wallet-${{ github.event.inputs.extension-version }}
  ARTIFACTS_FOLDER: artifacts
  S3_PATH: s3://releases.blockwallet.io/extension
  CHROME_VERSION: 97.0.4692.71
  TARGET_BRANCH: master

jobs:
  validation:
    runs-on: [self-hosted, release]
    steps:
      - name: Print user input
        run: |
          echo -e "Versions:\n
              extension-version: ${{ github.event.inputs.extension-version }}\n \
              background-version: ${{ github.event.inputs.background-version }}\n \
              ui-version: ${{ github.event.inputs.ui-version }}\n \
              provider-version: ${{ github.event.inputs.provider-version }}"
          echo -e pre-release: ${{ github.event.inputs.pre-release }}
          echo -e release-notes: ${{ github.event.inputs.release-notes }}

      - name: Parse and validate extension version string
        id: semver_extension
        uses: booxmedialtd/ws-action-parse-semver@v1
        with:
          input_string: ${{ github.event.inputs.extension-version }}
          version_extractor_regex: "v(.*)$"

      - name: Parse and validate background semver string
        id: semver_background
        uses: booxmedialtd/ws-action-parse-semver@v1
        with:
          input_string: ${{ github.event.inputs.background-version }}
          version_extractor_regex: "v(.*)$"

      - name: Parse and validate ui semver string
        id: semver_ui
        uses: booxmedialtd/ws-action-parse-semver@v1
        with:
          input_string: ${{ github.event.inputs.ui-version }}
          version_extractor_regex: "v(.*)$"

      - name: Parse and validate provider semver string
        id: semver_provider
        uses: booxmedialtd/ws-action-parse-semver@v1
        with:
          input_string: ${{ github.event.inputs.provider-version }}
          version_extractor_regex: "v(.*)$"

      - name: Validate release notes is a valid JSON
        env:
          DATA: "${{ github.event.inputs.release-notes }}"
          READ_ONLY: 1
        run: |
          wget https://raw.githubusercontent.com/block-wallet/release-helpers/main/validate_release_notes_and_convert_to_markdown.py -O validate_release_notes_and_convert_to_markdown.py
          python3 validate_release_notes_and_convert_to_markdown.py

      - name: Validate the extension version
        run: |
          if [[ "${{ steps.semver_extension.outputs.prerelease }}" != "" || "${{ steps.semver_extension.outputs.build }}" != "" ]]
          then
            echo "The release must follow the notation MAJOR.MINOR.PATCH without pre-release or build metadata."
            exit 1
          fi
        if: ${{ github.event.inputs.pre-release == 'false' }}

      - name: Validate dependencies versions aren't pre-releases if it's not a pre-release
        run: |
          if [[ "${{ steps.semver_background.outputs.prerelease }}" != "" || "${{ steps.semver_ui.outputs.prerelease }}" != "" || "${{ steps.semver_provider.outputs.prerelease }}" != "" ]]
          then
            echo "The release wasn't marked as a pre-release but one or more dependencies version are a pre-release"
            exit 1
          fi
        if: ${{ github.event.inputs.pre-release == 'false' }}

      - name: Validate release branch
        run: |
          if [[ "$GITHUB_REF_NAME" != "$TARGET_BRANCH" ]]
          then
            echo "You have to use $TARGET_BRANCH."
            exit 1
          fi

      - name: Check if background version exists in its repository
        uses: actions/checkout@v3
        with:
          repository: block-wallet/extension-background
          ref: ${{ github.event.inputs.background-version }}
          token: ${{ secrets.PAT }}

      - name: Check if ui version exists in its repository
        uses: actions/checkout@v3
        with:
          repository: block-wallet/extension-ui
          ref: ${{ github.event.inputs.ui-version }}
          token: ${{ secrets.PAT }}

      - name: Check if provider version exists in its repository
        uses: actions/checkout@v3
        with:
          repository: block-wallet/extension-provider
          ref: ${{ github.event.inputs.provider-version }}
          token: ${{ secrets.PAT }}

      - name: Install semver package
        run: |
          wget -O /usr/local/bin/semver \https://raw.githubusercontent.com/block-wallet/release-helpers/main/semver
          chmod +x /usr/local/bin/semver

      - name: Check out code
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.PAT }}
          ref: ${{ env.GITHUB_REF_NAME }}

      - name: Compare release version with the latest tag
        id: tag_comparison
        run: |
          latest_tag=$(git ls-remote --tags --sort='v:refname' origin | cut --delimiter='/' --fields=3 | tail -n 1)
          if [[ -z $latest_tag ]]
          then
            exit 0
          fi
          result=$(semver compare ${{github.event.inputs.extension-version}} $latest_tag)
          if [[ "$result" != "1" ]]
          then
            echo "The proposed tag for the release  \"v${{ steps.semver_extension.outputs.fullversion }}\" is not greater than the latest one \"$latest_tag\""
            exit 1
          fi

  build:
    needs: validation
    runs-on: [self-hosted, release]
    outputs:
      version_without_preffix: ${{ steps.remove_preffix.outputs.version }}
    steps:
      - name: Check out code
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.PAT }}
          ref: ${{ env.TARGET_BRANCH }}

      - name: Remove preffix from the extension version
        id: remove_preffix
        run: |
          updated_version=${{ github.event.inputs.extension-version }}
          echo $updated_version
          updated_version=$(echo ${updated_version:1})
          echo "::set-output name=version::$updated_version"

      - name: Initialize mandatory git config
        run: |
          git config --global user.name release_process
          git config --global user.email release_process@blockwallet.io
          git config --global url.https://$GH_ACCESS_TOKEN@github.com/.insteadOf https://github.com/

      - name: Create release branch
        run: |
          existed_in_remote=$(git ls-remote --heads origin ${RELEASE_BRANCH}) 
          if [[ ${existed_in_remote} ]]; then
            echo "Deleting the branch \"$RELEASE_BRANCH\" to continue with the release"
            git push origin --delete $RELEASE_BRANCH
          fi
          git checkout -b $RELEASE_BRANCH
          git push -u origin $RELEASE_BRANCH

      - name: Update new version
        env:
          VERSION: ${{ steps.remove_preffix.outputs.version }}
        run: |
          wget https://raw.githubusercontent.com/block-wallet/release-helpers/main/update_file.py -O update_file.py
          FILE=package.json python3 update_file.py
          FILE=public/manifest.json python3 update_file.py

      - name: Update release notes
        env:
          VERSION: ${{ steps.remove_preffix.outputs.version }}
          DATA: "${{ github.event.inputs.release-notes }}"
        run: |
          FILE=release-notes.json python3 update_file.py
          rm update_file.py

      - name: Commit package.json, manifest.json and release-notes.json
        id: version_commit
        run: |
          git add package.json release-notes.json public/manifest.json
          git commit --message "Update files with the new version ${{ github.event.inputs.extension-version }} and also add the new release notes"
          git push origin $RELEASE_BRANCH

      - name: Update ui submodule
        uses: actions/checkout@v3
        with:
          repository: block-wallet/extension-ui
          ref: ${{ github.event.inputs.ui-version }}
          path: packages/ui/
          token: ${{ secrets.PAT }}

      - name: Update provider submodule
        uses: actions/checkout@v3
        with:
          repository: block-wallet/extension-provider
          ref: ${{ github.event.inputs.provider-version }}
          path: packages/provider/
          token: ${{ secrets.PAT }}

      - name: Update background submodule
        uses: actions/checkout@v3
        with:
          repository: block-wallet/extension-background
          ref: ${{ github.event.inputs.background-version }}
          path: packages/background/
          token: ${{ secrets.PAT }}

      - name: Commit updated submodules
        id: packages_commit
        run: |
          git add packages/
          if [[ -z "$(git status | grep packages/)" ]]
          then
            echo "The submodules weren't updated with the tags defined in the input. Review them and make again the release"
            exit 1
          fi
          git commit -m "Update packages with new versions"
          git push origin $RELEASE_BRANCH

      - name: Install node
        uses: actions/setup-node@v3
        with:
          node-version-file: .nvmrc

      - name: Install yarn
        run: |
          curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | sudo apt-key add -
          echo "deb https://dl.yarnpkg.com/debian/ stable main" | sudo tee /etc/apt/sources.list.d/yarn.list
          sudo apt update
          apt install -y yarn --no-install-recommends

      - name: Checkout make scripts
        uses: actions/checkout@v2
        with:
          repository: block-wallet/block-make
          ref: refs/heads/main
          path: .make
          token: ${{ secrets.PAT }}

      - uses: actions/cache@v3
        with:
          path: "**/node_modules"
          key: ${{ runner.os }}-modules-${{ hashFiles('**/yarn.lock') }}

      - name: Install packages dependencies
        env:
          GITHUB_TOKEN: ${{ secrets.PAT }}
        run: |
          make install/ci

      - name: Build extension
        env:
          CI: false
        run: |
          make build/prod

      - name: Save extension folder
        uses: actions/upload-artifact@v2
        with:
          name: blockwallet-extension
          if-no-files-found: error
          path: dist

  tests:
    needs: build
    runs-on: [self-hosted, release]
    env:
      WIDTH: 357
      HEIGHT: 610
      DBUS_SESSION_BUS_ADDRESS: /dev/null
    steps:
      - name: Checkout e2e repository
        uses: actions/checkout@v2
        with:
          repository: block-wallet/e2e-tests
          ref: refs/heads/main
          token: ${{ secrets.PAT }}

      - name: Install node
        uses: actions/setup-node@v3
        with:
          node-version-file: .nvmrc

      - name: Install yarn
        run: |
          curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | sudo apt-key add -
          echo "deb https://dl.yarnpkg.com/debian/ stable main" | sudo tee /etc/apt/sources.list.d/yarn.list
          sudo apt update
          apt install -y yarn --no-install-recommends

      - name: Cache e2e dependencies and cypress binary
        id: cache-cypress
        uses: actions/cache@v3
        with:
          path: |
            **/node_modules
            ~/.cache/Cypress
          key: ${{ runner.os }}-cypress-${{ hashFiles('**/yarn.lock') }}

      - name: Download the extension
        uses: actions/download-artifact@v2
        with:
          name: blockwallet-extension
          path: blockwallet-extension

      - name: Install Cypress linux dependencies
        run: |
          apt install -y libgtk2.0-0 libgtk-3-0 libgbm-dev libnotify-dev libgconf-2-4 libnss3 libxss1 libasound2 libxtst6 xauth xvfb

      - name: Install e2e dependencies
        run: |
          yarn install --prefer-offline --frozen-lockfile

      - name: Cache Chrome
        uses: actions/cache@v3
        id: cache-chrome
        with:
          path: /usr/src/google-chrome-stable_current_amd64.deb
          key: ${{ env.CHROME_VERSION }}

      - name: Download Chrome
        if: steps.cache-chrome.outputs.cache-hit != 'true'
        run: |
          wget -O /usr/src/google-chrome-stable_current_amd64.deb "http://dl.google.com/linux/chrome/deb/pool/main/g/google-chrome-stable/google-chrome-stable_$CHROME_VERSION-1_amd64.deb"

      - name: Install Chrome
        run: |
          apt install -y /usr/src/google-chrome-stable_current_amd64.deb

      - name: UI Tests - Chrome
        run: |
          yarn run test:e2e
        env:
          ETHERSCAN_KEY: ${{ secrets.ETHERSCAN_KEY }}
          GITHUB_TOKEN: ${{ secrets.PAT }}
          TEST_TAGS: puppeteer,extension

      - name: Take the release notes screenshot
        run: |
          yarn run test:e2e
        env:
          EXTENSION_VERSION: ${{ needs.build.outputs.version_without_preffix }}
          TEST_TAGS: release-notes
          BROWSER_WIDTH: ${{ env.WIDTH }}
          BROWSER_HEIGHT: ${{ env.HEIGHT }}

      - name: Install ImageMagick (needed for convert)
        run: |
          apt install -y imagemagick

      - name: Cut the screenshot
        run: |
          convert screenshots/release-notes-${{ needs.build.outputs.version_without_preffix }}.png -crop ${{ env.WIDTH }}x${{ env.HEIGHT }}+0+0 $EXTENSION_NAME.png

      - name: Save screenshot of release notes
        uses: actions/upload-artifact@v2
        with:
          name: screenshot
          if-no-files-found: error
          path: ${{ env.EXTENSION_NAME }}.png

  package:
    needs: tests
    runs-on: [self-hosted, release]
    steps:
      - name: Delete artifacts folders
        run: |
          rm -rf screenshot
          rm -rf blockwallet-extension

      - name: Download the extension built folder
        uses: actions/download-artifact@v2
        with:
          name: blockwallet-extension
          path: blockwallet-extension

      - name: Download the extension screenshot (release notes)
        uses: actions/download-artifact@v2
        with:
          name: screenshot
          path: screenshot

      - name: Zip extension
        id: zip
        run: |
          apt install -y zip
          mkdir -p $ARTIFACTS_FOLDER
          mv blockwallet-extension dist
          zip -r -D $ARTIFACTS_FOLDER/$EXTENSION_NAME.zip dist/

      - name: Calculate SHA of the extension
        id: sha
        run: |
          cd $ARTIFACTS_FOLDER
          sha256sum $EXTENSION_NAME.zip > $EXTENSION_NAME.checksum

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_RELEASE_BUCKET }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_RELEASE_BUCKET }}
          aws-region: eu-central-1

      - name: Upload to S3
        run: |
          aws s3 cp --recursive $ARTIFACTS_FOLDER $S3_PATH
          aws s3 cp screenshot/$EXTENSION_NAME.png $S3_PATH/$EXTENSION_NAME.png

      - name: Upload version and notes to S3
        env:
          DATA: "${{ github.event.inputs.release-notes }}"
        run: |
          echo "{" > version.json
          echo "\"extension\": \"${{ github.event.inputs.extension-version }}\"," >> version.json
          echo "\"background\": \"${{ github.event.inputs.background-version }}\"," >> version.json
          echo "\"provider\": \"${{ github.event.inputs.provider-version }}\"," >> version.json
          echo "\"ui\": \"${{ github.event.inputs.ui-version }}\"," >> version.json
          echo "\"prerelease\": \"${{ github.event.inputs.pre-release }}\"" >> version.json
          echo "}"  >> version.json
                    
          aws s3 cp version.json $S3_PATH/version.json

          wget https://raw.githubusercontent.com/block-wallet/release-helpers/main/validate_release_notes_and_convert_to_markdown.py -O validate_release_notes_and_convert_to_markdown.py
          python3 validate_release_notes_and_convert_to_markdown.py

          aws s3 cp notes.md $S3_PATH/notes.md

  pull_request:
    outputs:
      pr_url: ${{ steps.create_pull_request.outputs.pr_url }}
    needs: package
    runs-on: [self-hosted, release]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.PAT }}

      - name: Initialize mandatory git config
        run: |
          git config --global user.name release_process
          git config --global user.email release_process@blockwallet.io
          git config --global url.https://$GH_ACCESS_TOKEN@github.com/.insteadOf https://github.com/

      - name: Install GitHub cli
        run: |
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh

      - name: Create Pull Request
        id: create_pull_request
        env:
          GH_TOKEN: ${{ secrets.PAT }}
        run: |
          s3_url=$(echo "${S3_PATH/s3/https}")
          pr_title="[Automated] Extension release ${{ github.event.inputs.extension-version }}"
          pr_body=$(echo -e "# PR for release ${{ github.event.inputs.extension-version }}\n\n## Type of change :writing_hand:\n\nClick the correct/s option/s\n\n- [ ] Bug fix (non-breaking change which fixes an issue)\n- [ ] New feature (non-breaking change which adds functionality)\n- [ ] Breaking change (fix or feature that would cause existing functionality to not work as expected)\n- [ ] This change requires a documentation update\n\n## Manual tests :test_tube:\n\n- [ ] I run the tests and they were succesful\n\n## Artifacts :space_invader:\n\n - [Extension zip]($s3_url/${{ env.EXTENSION_NAME }}.zip)\n - [Release notes screenshot]($s3_url/${{ env.EXTENSION_NAME }}.png)\n - [SHA256 checksum]($s3_url/${{ env.EXTENSION_NAME }}.checksum)\n\n## Dependencies :link: \n\n\n - Background: [${{ github.event.inputs.background-version }}](https://github.com/block-wallet/extension-background/releases/tag/${{ github.event.inputs.background-version }})\n - UI: [${{ github.event.inputs.ui-version }}](https://github.com/block-wallet/extension-ui/releases/tag/${{ github.event.inputs.ui-version }})\n - Provider: [${{ github.event.inputs.provider-version }}](https://github.com/block-wallet/extension-provider/releases/tag/${{ github.event.inputs.provider-version }})\n")
          pr_reviewer="block-wallet/releasereviewers"
          pr_assignee="leablock"
          pr_label="automated,release"

          gh label create --force "automated" --description "PR made by an automation" --color "bcf5db"
          gh label create --force "release" --description "Extension release" --color "0e8a16"

          gh pr create \
            --base "$TARGET_BRANCH" \
            --head "$RELEASE_BRANCH" \
            --title "$pr_title" \
            --label "$pr_label" \
            --reviewer "$pr_reviewer" \
            --body "$pr_body" \
            --assignee "$pr_assignee"  \
            --no-maintainer-edit \
            --draft

          sleep 5

          url=$(gh pr list --state open --label "$pr_label" --base "$TARGET_BRANCH" --head "$RELEASE_BRANCH" --json url |  jq ".[0].url" | tr -d '"')
          echo "::set-output name=pr_url::$url"

  notify:
    if: success()
    needs: [validation, build, tests, package, pull_request]
    runs-on: [self-hosted, release]
    steps:
      - name: Slack notification - Ready to release
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          fields: repo,workflow
          github_token: ${{ secrets.PAT }}
          custom_payload: |
            {
              "text": "*Release (manual)* for ${{ github.event.inputs.extension-version }} finished.",
              "attachments": [
                {
                  "color": "good",
                  "pretext": "The pull request was created. After reviewing it, please merge it to continue the release process that will launch *Release (automated)*. CC: <@U01H6J242BY>",
                  "author_name": "GitHub Pull Request ${{ github.event.inputs.extension-version }}",
                  "author_link": "${{ needs.pull_request.outputs.pr_url }}",
                  "title": "GitHub Pull Request for the release ${{ github.event.inputs.extension-version }} created as draft"
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_BLOCKWALLET_RELEASES }}
  error:
    if: failure()
    needs: [validation, build, tests, package, pull_request, notify]
    runs-on: [self-hosted, release]
    steps:
      - name: Slack notification - CI status
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          fields: workflow
          github_token: ${{ secrets.PAT }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_ALERTS_RELEASES }}
